<?php
/**
 * Bazar template to render a course entry.
 * This files is copied at installation (cf handlers/page/update__.php) to custom/templates/themes/bazar/templates/
 * directory of the yeswiki root.
 * The filename is fiche-X.tpl.html with X defined by $GLOBALS['wiki']->config['lms_config']['course_form_id']
 * (by default 1203). If the course ID change, the installation must be performed again.
 */

use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface;
use YesWiki\Bazar\Service\EntryManager;
use YesWiki\Core\Service\TemplateEngine;
use YesWiki\Lms\Controller\CourseController;
use YesWiki\Lms\Module;
use YesWiki\Lms\Service\CourseManager;

?>

<div class="course-container <?php echo $GLOBALS['wiki']->userIsAdmin() ? 'admin-user' : ''?>">
  <?php
    $courseController = $GLOBALS['wiki']->services->get(CourseController::class);
    $courseManager = $GLOBALS['wiki']->services->get(CourseManager::class);

    $course = $courseManager->getCourse($fiche['id_fiche'], $fiche);

    if (!empty($html['bf_titre'])) {
        $content = $html['bf_titre'];
    }
    if (!empty($html['bf_description'])) {
        $content .= $html['bf_description'];
        // depends on the html tags generated by textelong(..) with mode = 'html' (cf. formulaire.fonct.inc.php)
        // if the html tags are not found, set all the content with the field label
        $pattern = '~^<div class="BAZ_rubrique" data-id="bf_contenu">\s*<span class="BAZ_label">Description<\/span>\s*<span class="BAZ_texte">\s*(.*)<\/span>\s*<\/div>\s*<!-- \/\.BAZ_rubrique -->$~mis';
        $matches = [];
        $content = preg_match($pattern, $content, $matches) ? $matches[1] : $content;
        echo '<div class="course-description">' . $content . '</div>';
    }
    if (empty($course->getModules())){
      if ($GLOBALS['wiki']->userIsAdmin()) {
        echo '<div class="alert alert-info">'._t('LMS_ADMIN_NO_MODULES').'.</div>';
      } else {
        echo '<div class="alert alert-info">'._t('LMS_NO_MODULES').'.</div>';
      }
    } else { // Show modules list
      echo '<div class="module-list">'."\n";

      foreach($course->getModules() as $module) {
        echo $courseController->renderModuleCard($course, $module);
      }
      echo '</div> <!-- end .module-list -->'."\n";
    }
    if ($GLOBALS['wiki']->userIsAdmin()) : ?>
      <div class="admin-infos well">
        <h3><?php echo _t('LMS_RESERVED_FOR_ADMINS'); ?></h3>
        <p><strong><?php echo _t('LMS_ACTIVITY_SCENARISATION'); ?></strong> : <?php echo $course->getField('listeListeOuinonLmsbf_scenarisation_activites'); ?></p>
        <p><strong><?php echo _t('LMS_MODULE_SCENARISATION'); ?></strong> : <?php echo $course->getField('listeListeOuinonLmsbf_scenarisation_modules'); ?></p>
        <div class="dashboard-launch">
            <a href="<?php echo $GLOBALS['wiki']->href(null, 'ProgressDashboard', ['parcours' => $course->getTag()]) ?>"
               class="btn btn-secondary-2 btn-large">
                <i class="fas fa-chart-bar"></i><?php echo _t('LMS_VIEW_PROGRESS_DASHBOARD') ?>
            </a>
        </div>
      </div>
    <?php endif; ?>
</div> <!-- /.course-container -->
