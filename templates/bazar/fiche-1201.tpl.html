<?php
/**
 * Bazar template to render an Activity entry.
 * This files is copied at installation (cf handlers/page/update__.php) to custom/templates/themes/bazar/templates/
 * directory of the yeswiki root.
 * The filename is fiche-X.tpl.html with X defined by $GLOBALS['wiki']->config['lms_config']['activity_form_id']
 * (by default 1201). If the activity ID change, the installation must be performed again.
 */

use YesWiki\Lms\Controller\CourseController;
use YesWiki\Lms\Service\LearnerManager;

?>

<div class="container lms-container <?php echo $GLOBALS['wiki']->userIsAdmin() ? 'admin-user' : '' ?>">
    <div class="row">
        <div class="col-md-3 lms-menu">
            <?php
            // display the PageMenuLms page if it exists
            if ($GLOBALS['wiki']->LoadPage('PageMenuLms')) {
                echo $GLOBALS['wiki']->Format('{{include page="PageMenuLms"}}');
            }
            ?>
        </div>
        <div class="col-md-9 lms-activity-content">
            <?php
            $courseController = $GLOBALS['wiki']->services->get(CourseController::class);
            $learnerManager = $GLOBALS['wiki']->services->get(LearnerManager::class);

            // the consulted course entry
            $course = $courseController->getContextualCourse();
            // the consulted module entry to display the current activity
            $module = $courseController->getContextualModule($course);
            // the current learner
            $learner = $learnerManager->getLearner();

            if (!$course || !$module || $module->isAccessibleBy($learner, $course)) {
                $title = ($GLOBALS['wiki']->config['lms_config']['display_activity_title'] && !empty($html['bf_titre'])) ?
                    $html['bf_titre'] :
                    '';
                $content = !empty($html['bf_contenu']) ? $html['bf_contenu'] : '';
                // depends on the html tags generated by textelong(..) with mode = 'html' (cf. formulaire.fonct.inc.php)
                // if the html tags are not found, set all the content with the field label
                $pattern = '~^<div class="BAZ_rubrique" data-id="bf_contenu">\s*<span class="BAZ_label">Contenu<\/span>\s*<span class="BAZ_texte">\s*(.*)<\/span>\s*<\/div>\s*<!-- \/\.BAZ_rubrique -->$~mis';
                $matches = [];
                $content = preg_match($pattern, $content, $matches) ? $matches[1] : $content;
                echo $title . $content;

                if (!empty($html['reactions']) && $course && $module) {
                    echo $html['reactions'];
                }
                if (!empty($html['bf_navigation']) && $course && $module) {
                    echo $html['bf_navigation'];
                }
            } else {
                echo '<div class="alert alert-danger">' . _t('LMS_ACTIVITY_NOT_ACCESSIBLE') . '</div>';
            }
            ?>
        </div>
    </div><!-- /.row -->
</div> <!-- /.container -->
